<div id="whole-content" style="display: none;">
{% extends 'main/index.html' %}
{% load static %}
{% block content %}

<!-- add incident -->

            <div class="container">
                
                <form method="post">
                    <div class="row">
                    <div class="card">
                        <div class="card-header align-items-center d-flex justify-content-between">
                            <h4 class="mb-sm-0">Incident and Case Management</h4>
                        </div>
                        
                        <div class="row">
                        <div class="col-lg-6">
                        <div class="asterisk">
                            <label for="" class="case_title-label"><br>Case Title<span> *</span></label>
                            <input type="form" class="form-control" id="case_title" placeholder="Enter Case Title">
                        </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="asterisk">
                            <label for="happened" class="form-label"></br>Date Happened<span> *</span></label>
                            <input type="date" class="form-control" id="happened">
                        </div>
                    </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6"> 
                            <div class="asterisk">
                            <div class="optional">
                        <label class="form-label1" for="case_description"><br>Case Description</label>
                        <textarea class="form-control" placeholder="Enter Description" id="case_description" rows="6"></textarea>
                       </div>
                       
                </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="asterisk">
                        <label for="status" class="form-label1"><br>Status<span> *</span></label>
                        <select class="form-select" id="status">
                            <option value=""></option>
                            <option value="Ongoing">Ongoing</option>
                            <option value="Done">Done</option>
                            <option value="Pending">Pending</option>          
                        </select>
                    </div>
                    </div>
                    </div>
                    <div class="col-lg-6">
                    <div class="optional">
                    <label for="formFile" class="form-label"><br>Upload File</label>
                    <input class="form-control" type="file" id="formFile" />
                </div>
                </div>
                </div>
                <div class="row">
                    <div class="col-lg-6"> 
                        <div class="asterisk">
                        <label for="complainant" class="form-label1"><br>Name of Complainant<span> *</span></label>
                        <input type="form" class="form-control" id="complainant" placeholder="Name of complainant">
                    </div>
                </div>

                    <div class="col-lg-6"> 
                        <div class="asterisk">
                        <label for="subject_complaint" class="form-label1"><br>Subject to Complaint<span> *</span></label>
                        <input type="form" class="form-control" id="subject_complaint" placeholder="subject to complaint">
                    </div>
                </div>
                </div>
                <div class="row">
                <div class="col-lg-6"> 
                    <div class="asterisk">
                    <label for="witness" class="form-label1"><br>Name of Witness<span> *</span></label>
                    <input type="form" class="form-control" id="witness" placeholder="Name of Witness">
                </div>
            </div>
        
                <div class="col-lg-6"> 
                    <div class="asterisk">
                    <label for="place" class="form-label1"><br>Place<span> *</span></label>
                    <input type="form" class="form-control" id="place" placeholder="Place">
                </div>
            </div>
            </div>
            <div class="row">
            <div class="col-lg-6"> 
                <div class="asterisk">
                <label for="officer" class="form-label1"><br>Name of Officer<span> *</span></label>
                <input type="form" class="form-control" id="officer" placeholder="Name of Officer in charge">
            </div>
        </div>
        </div>
                        <div class="mt-4">
                            <div class="hstack gap-2 justify-content-end">
                                <button type="button" class="btn btn-primary waves-effect waves-light cancel-button" data-bs-toggle="modal" data-bs-target="#cancelmodal">Cancel</button>
                                <div class="modal fade" id="cancelmodal" aria-hidden="true"  tabindex="-1">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-body text-center p-5">
                                                <div class="mt-4">
                                                    <h4 class="mb-3">Are you sure you want to cancel?</h4>
                                                    <div class="hstack gap-2 justify-content-center">
                                                        <button  class="btn btn-light"  data-bs-target="#cancelmodal" data-bs-toggle="modal"  data-bs-dismiss="modal">No</button>
                                                        <a href="{% url 'incident_logs' %}" class="btn btn-danger">Yes</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div><!-- /.modal-content -->
                                    </div><!-- /.modal-dialog -->
                                </div><!-- /.modal -->
                                <button type="button" class="btn btn-success waves-effect waves-light"  id="confirmSubmitBtn">Save</button>
                                </div>
                            </div><!-- end button container -->
                        </div>
                    </div>
                <br>
            </div>
        </div>
        </form>
    </div>
    </div> <!--div protection-->
<!--end add board modal-->

{% block css %}
<link rel="stylesheet" href="{% static 'css/add_incident.css' %}">
{% endblock %}

{% block js %}
<script src="{% static 'libs/@ckeditor/ckeditor5-build-classic/build/ckeditor.js' %}"></script>
 <!-- dropzone js -->
 <script src="{% static 'libs/dropzone/dropzone-min.js' %}"></script>
 <!-- project-create init -->
 <script src="{% static 'js/pages/project-create.init.js' %}"></script>

 <!-- App js -->
 <script src="{% static 'js/app.js' %}"></script>
 <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
 <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
 <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
 <script>
 
    // Function to handle form submission
    function submitForm() {
        //Retrieve token

        var token = localStorage.getItem('token');
        // Create a FormData object
        var formData = new FormData();
    
        // Append form fields to formData
        formData.append('case_title', $('#case_title').val());
        formData.append('case_description', $('#case_description').val());
        formData.append('complainant', $('#complainant').val());
        formData.append('witness', $('#witness').val());
        formData.append('officer', $('#officer').val());
        formData.append('subject_complaint', $('#subject_complaint').val());
        formData.append('place', $('#place').val());
        formData.append('happened', $('#happened ').val());
        formData.append('status', $('#status').val());
      
    
        var fileInput = $('#formFile')[0];
    
        if (fileInput.files.length > 0) {
            formData.append('photo_path', fileInput.files[0]);
        } else {
            console.error("No file selected");
            return;
        }
    
    
        $.ajax({
            url: 'http://127.0.0.1:8000/incidents/add',
            type: 'POST',
            headers: {
                "Authorization": "Bearer " + localStorage.getItem('token')
            },
            data: formData,
            contentType: false,
            processData: false,
            success: function(response) {
                console.log(response);
            },
            error: function(xhr, status, error) {
                console.error("AJAX Error:", status, error);
                var responseJSON = xhr.responseJSON;
                if (responseJSON && responseJSON.detail) {
                    console.error("Detailed Error:", responseJSON.detail);
            }
        }
        });
    }  
  $(document).ready(function () {
    $("#confirmSubmitBtn").unbind('click').click(function (event) {
        event.preventDefault();
        var isValid = true;
        $('.asterisk input, .asterisk select, .asterisk textarea').each(function () { // Modified selector to target all input, select, and textarea elements within elements with class .asterisk
            var fieldValue = $(this).val();
            if (!fieldValue || fieldValue.trim() === '') { // Check if no value is entered or if the entered value is empty
                $(this).addClass('is-invalid');
                isValid = false;
                Swal.fire({
                    icon: "error",
                    title: "Oops...",
                    text: "Incident fields are required! ",
                });
            } else {
                $(this).removeClass('is-invalid');
            }
        });

        if (isValid) {
            confirmSave();
        }
    });

    // Optional: Add an event listener to remove the red border when the user starts typing
    $('.asterisk input, .asterisk select.form-select, .asterisk textarea').on('input', function () {
        if ($(this).val().trim() !== '') {
            $(this).removeClass('is-invalid');
        }
    });
    
  
});

//SAVE MODAL
function confirmSave() {
                Swal.fire({
                    title: "Do you want to save the changes?",
                    showDenyButton: true,
                    showCancelButton: true,
                    confirmButtonText: "Save",
                    denyButtonText: `Don't save`
                }).then((result) => {
                    if (result.isConfirmed) {
                        // SweetAlert confirmation
                        Swal.fire("Saved!", "", "success").then(() => {
                            // Trigger the form submission when "Save" is clicked
                            submitForm();
                        });
                    } else if (result.isDenied) {
                        Swal.fire("Changes are not saved", "", "info");
                        // Handle any additional actions or don't open the first modal
                    }
                });
            }
    
 //SECURITY--------------
    // Check for the token when the page loads
    document.addEventListener("DOMContentLoaded", function() {
         var token = localStorage.getItem('token');
         if (token) {
             // Show the services content if the token is present
             document.getElementById('whole-content').style.display = 'block';
         } else {
             // Redirect to login if token is not present
             window.location.href = "/login";  // Adjust the login page URL if necessary
         }
     });
    </script>

{% endblock %}
{% endblock %}
